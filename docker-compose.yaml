services:
 mqtt:
   image: eclipse-mosquitto
   restart: unless-stopped
   ports:
     - "1893:1883"
   volumes:
     - ./mosquitto/config:/mosquitto/config   # bind mount so host can edit/share config
     - mosquitto_data:/mosquitto/data
     - mosquitto_log:/mosquitto/log
   networks:
     - default
     - internal_net

 controller:
   image: controller
   restart: unless-stopped
   networks:
     - internal_net
   depends_on:
     - mqtt
   environment:
     - MQTT_BROKER=mqtt
     - MQTT_PORT=1883
   volumes:
     - ./mosquitto/config:/mosquitto/config
     - mosquitto_log:/mosquitto/log

 NodeRed:
   image: nodered/node-red
   restart: unless-stopped
   ports:
     - "1880:1880"
   volumes:
     - nodered_data:/data
   networks:
     - default
     - internal_net
   depends_on:
     - mqtt
   environment:
     - MQTT_BROKER=mqtt
     - MQTT_PORT=1883
     - INFLUXDB_HOST=influxdb
     - INFLUXDB_PORT=8086

 influxdb:
   image: influxdb:2
   restart: unless-stopped
   ports:
     - "8086:8086"
   volumes:
     - influxdb_data:/var/lib/influxdb
   networks:
     - default
     - internal_net

 portainer:
   image: portainer/portainer-ce
   restart: unless-stopped
   ports:
     - "9000:9000"
   volumes:
     - /var/run/docker.sock:/var/run/docker.sock
     - portainer_data:/data
   networks:
     - default

networks:
  internal_net:
    driver: bridge
    internal: true

volumes:
  mosquitto_config:
    driver: local
  mosquitto_data:
    driver: local
  mosquitto_log:
    driver: local
  nodered_data:
    driver: local
  influxdb_data:
    driver: local
  portainer_data:
    driver: local

